name: Deploy Project

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  AWS_REGION: "eu-west-2"
  S3_BUCKET: "seyi-codedeploy-artifacts"
  S3_KEY_PREFIX: "releases"
  CODEDEPLOY_APP: "my-node-app"
  CODEDEPLOY_GROUP: "seyi-dg"
  PACKAGE_NAME: "release-${{ github.sha }}.zip"

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:6
        ports: ['27017:27017']
        options: >-
          --health-cmd="mongosh --quiet --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Run unit tests
        env:
          MONGO_URL: mongodb://127.0.0.1:27017/acebook_test
        run: npm run test:unit

      - name: Start test server and run Cypress integration tests
        uses: cypress-io/github-action@v6
        with:
          install: false
          start: npm run start:test
          wait-on: 'http://localhost:3030'
        env:
          MONGO_URL: mongodb://127.0.0.1:27017/acebook_test
          CYPRESS_baseUrl: http://localhost:3030

      - name: Build (production)
        run: |
          npm run build --if-present
          npm ci --omit=dev

      - name: Package for deployment
        run: |
          mkdir -p bundle
          zip -r "${PACKAGE_NAME}" \
            appspec.yml \
            scripts/ \
            app.js \
            controllers/ models/ routes/ views/ public/ \
            package.json package-lock.json \
            -x "node_modules/*" ".git/*" ".github/*" "*.log"

      - name: Upload artifact for next job
        uses: actions/upload-artifact@v4
        with:
          name: codedeploy-bundle
          path: ${{ env.PACKAGE_NAME }}

  deploy:
    name: Deploy to EC2 (CodeDeploy)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Download bundle
        uses: actions/download-artifact@v4
        with:
          name: codedeploy-bundle

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to S3
        run: |
          aws s3 cp "${{ env.PACKAGE_NAME }}" \
            "s3://${{ env.S3_BUCKET }}/${{ env.S3_KEY_PREFIX }}/${{ env.PACKAGE_NAME }}"

      - name: Create CodeDeploy deployment
        run: |
          aws deploy create-deployment \
            --application-name "${{ env.CODEDEPLOY_APP }}" \
            --deployment-group-name "${{ env.CODEDEPLOY_GROUP }}" \
            --deployment-config-name CodeDeployDefault.AllAtOnce \
            --s3-location bucket=${{ env.S3_BUCKET }},bundleType=zip,key=${{ env.S3_KEY_PREFIX }}/${{ env.PACKAGE_NAME }}
